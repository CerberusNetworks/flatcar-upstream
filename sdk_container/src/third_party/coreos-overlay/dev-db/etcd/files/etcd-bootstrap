#!/bin/bash

#TODO: Generating a config file rather than args so etcd-bootstrap can run as a
#      completely separate unit from etcd

VIRT=$(coreos-detect-virt)
STATE=/var/lib/etcd
ARGS="-f -data-dir $STATE -bind-addr 0.0.0.0"

if [ "${VIRT}" != "ec2" ]; then
	echo "Detected environment \"${VIRT}\", just starting solo master..."
	exec /usr/bin/etcd ${ARGS} -n ${HOSTNAME}
else
	ARGS="${ARGS} -peer-election-timeout 1200"
fi

BOOTSTRAP_PEERS="/var/run/etcd/bootstrap.config"
BOOTSTRAP_DISCO="/var/run/etcd/bootstrap.disco"

META_URL="http://169.254.169.254/latest"
MY_IP=$(curl -s $META_URL/meta-data/local-ipv4)

ARGS="${ARGS} -name ${MY_IP} -addr ${MY_IP}:4001 -peer-addr ${MY_IP}:7001 -peer-bind-addr 0.0.0.0"

if [ -e $BOOTSTRAP_DISCO ]; then
	DISCOVERY_URL="$(cat $BOOTSTRAP_DISCO)"
	ARGS="${ARGS} -discovery ${DISCOVERY_URL}"

elif [ -e $BOOTSTRAP_PEERS ]; then
	IPS=$(grep -v $MY_IP $BOOTSTRAP_PEERS | grep -v '^\n$' | sed 's/$/:7001/'| tr '\n' ','| sed 's/^,//' | sed 's/,$//')
	if [ -z "$IPS" ]; then
		ARGS="${ARGS} -C ${IPS}"
	fi
else 
	echo "Could not find any bootstrap configuration"
	exit 1
fi

exec /usr/bin/etcd $ARGS
