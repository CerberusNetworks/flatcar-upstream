From 6f36c5dba801f60119a75e20dd9df5369f005144 Mon Sep 17 00:00:00 2001
From: Vito Caputo <vito.caputo@coreos.com>
Date: Mon, 19 Oct 2015 17:53:12 -0700
Subject: [PATCH 19/21] overlayfs: use a minimal buffer in ovl_copy_xattr

Rather than always allocating the high-order XATTR_SIZE_MAX buffer
which is costly and prone to failure, only allocate what is needed and
realloc if necessary.

Fixes https://github.com/coreos/bugs/issues/489
---
 fs/overlayfs/copy_up.c | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/fs/overlayfs/copy_up.c b/fs/overlayfs/copy_up.c
index fa6610a..78c1aa3 100644
--- a/fs/overlayfs/copy_up.c
+++ b/fs/overlayfs/copy_up.c
@@ -70,6 +70,19 @@ retry:
 			value_size = size;
 			goto retry;
 		}
+
+		if (size > value_size) {
+			void *new;
+			new = krealloc(value, size, GFP_KERNEL);
+			if (!new) {
+				error = -ENOMEM;
+				goto out_free_value;
+			}
+			value = new;
+			value_size = size;
+			goto retry;
+		}
+
 		error = security_inode_copy_up_xattr(old, new,
 						     name, value, &size);
 		if (error < 0)
-- 
2.7.3

